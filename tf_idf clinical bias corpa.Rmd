---
title: "tf_idf clinical bias corpa"
author: "Drew Walker"
date: "9/23/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(remotes)
install_github("juliasilge/tidylo")
library(tidylo)
library(tidyverse)
library(stargazer)
library(table1)
library(lubridate)
library(redcapAPI)
library(here)
library(ruca)
library(postmastr)
library(tm)
library(wordcloud)
library(tidytext)
library(tibbletime)
```

```{r, load_data }
broad_patients <- read_csv("SC_NOTES_PATIENTS_BROAD.csv")
broad_patients <- broad_patients %>% 
  mutate(dataset = "broad")
crisis_patients <- read_csv("SC_NOTES_PATIENTS_CRISIS.csv")
crisis_patients <- crisis_patients %>% 
  mutate(dataset = "crisis")


```

# tf-idf from sl code
```{r, tf_idf_prep}

ff_record_id <- tf_redcap %>% 
  select(record_id, ff)
ff_words <- tf_redcap %>% 
  unnest_tokens(word,issues) %>% 
  left_join(ff_record_id,by = "record_id") %>% 
  group_by(ff) %>% 
  count(word,sort = TRUE,.drop = TRUE) %>% 
  ungroup()
ff_words_tf_idf <- ff_words %>% 
  bind_tf_idf(word,ff,n) %>% 
  arrange(desc(tf_idf)) %>% 
  bind_log_odds(feature = word, set = ff, n = n) %>% 
  mutate(lo_abs = abs(log_odds_weighted))
ff_words_tf_idf %>%
  group_by(ff) %>%
  slice_max(lo_abs, n = 15)%>%
  ungroup() %>%
  ggplot(aes(lo_abs, fct_reorder(word, lo_abs), fill = ff)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ff, ncol = 2, scales = "free") +
  labs(x = "weighted log odds", y = NULL)
```

